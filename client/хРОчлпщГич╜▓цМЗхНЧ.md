# ERP+CRM系统后端部署指南

## 系统要求
- Docker Desktop 4.0+（必须使用正式版，不推荐简化版）
- Windows 10+ 64位操作系统
- 至少4GB内存
- 至少10GB可用磁盘空间

## 部署步骤

### 1. 检查Docker Desktop状态
确保Docker Desktop已正确安装并运行。可以通过以下命令检查：
```powershell
docker --version
docker-compose --version
```

### 2. 使用简化配置部署
我们提供了一个简化的docker-compose配置，用于在本地快速部署后端服务。

#### 2.1 进入client目录
```powershell
cd h:\erpcrm\client
```

#### 2.2 启动服务
```powershell
docker-compose -f docker-compose-simple.yml up -d
```

这个命令会：
- 拉取MySQL 8.0.33和Redis 7.0.11镜像
- 构建后端服务镜像
- 启动所有服务

### 3. 检查服务状态

#### 3.1 查看容器状态
```powershell
docker-compose -f docker-compose-simple.yml ps
```

#### 3.2 查看日志
```powershell
docker-compose -f docker-compose-simple.yml logs -f backend
```

### 4. 访问后端服务
后端服务将在以下地址可用：
- API地址：http://localhost:8082/api
- 健康检查：http://localhost:8082/api/

### 5. 停止服务
```powershell
docker-compose -f docker-compose-simple.yml down
```

## 常见问题解决

### 问题1：Docker Desktop 500 Internal Server Error
解决方案：
1. 重启Docker Desktop
2. 检查系统资源（内存、磁盘空间）
3. 重置Docker Desktop配置（设置 -> 重置 -> 重置为出厂默认值）
4. 重新安装Docker Desktop

### 问题2：服务启动失败
检查日志：
```powershell
docker-compose -f docker-compose-simple.yml logs -f
```

常见原因：
- 端口被占用：检查3306、6379、8082端口是否被其他程序占用
- 资源不足：增加Docker Desktop的内存分配（建议至少4GB）
- 网络问题：检查网络连接，确保能访问Docker Hub

### 问题3：健康检查失败
解决方案：
1. 检查后端服务是否正常运行
2. 可以修改docker-compose-simple.yml中的健康检查配置
3. 使用简化的健康检查命令

## 代码与Docker Desktop冲突分析

### 1. 端口配置不一致
- **问题**：Dockerfile中暴露的端口（8080）与application.yml中配置的端口（8082）不一致
- **解决方案**：已在docker-compose-simple.yml中统一使用8082端口

### 2. JAR文件名不匹配
- **问题**：Dockerfile中指定的JAR文件名与实际构建结果不一致
- **解决方案**：已在Dockerfile.backend中修正为正确的JAR文件名

### 3. 缺少健康检查端点
- **问题**：后端服务缺少Spring Boot Actuator依赖，导致健康检查失败
- **解决方案**：使用简化的健康检查命令，直接访问根路径

### 4. 多阶段构建配置
- **问题**：原始Dockerfile使用多阶段构建，可能在某些环境下存在兼容性问题
- **解决方案**：保持多阶段构建，但优化了构建步骤

## 优化建议

1. **添加Spring Boot Actuator依赖**：在server/pom.xml中添加以下依赖，以支持完整的健康检查
   ```xml
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-actuator</artifactId>
   </dependency>
   ```

2. **统一端口配置**：确保所有配置文件中的端口保持一致

3. **优化健康检查**：使用专门的健康检查端点，如/actuator/health

4. **添加环境变量支持**：允许通过环境变量动态配置服务参数

## 总结

通过使用我们提供的简化配置，可以在Docker Desktop上成功部署后端服务。如果遇到问题，请按照常见问题解决部分进行排查，或联系技术支持。

**注意**：必须使用正式版Docker Desktop，简化版可能存在功能缺失和兼容性问题。

# ERP+CRM系统后端最终修复指南

## 一、问题分析

经过详细分析，我们遇到了以下问题：

1. **Docker Desktop代理配置错误**：Docker配置了无法工作的本地代理（`http://127.0.0.1:60283`），导致无法连接Docker Hub拉取任何镜像
2. **后端代码依赖缺失**：缺少ModelMapper和MyBatis Plus等关键依赖，导致编译失败
3. **LogisticsTrace.java代码错误**：使用了@Column注解的index()方法，但该方法在当前版本中不存在

## 二、修复步骤

### 1. 修复Docker Desktop代理配置

**这是最关键的一步！** 必须先修复Docker代理问题，否则无法拉取任何镜像。

#### 操作步骤：
1. 打开Docker Desktop应用
2. 点击右上角的设置图标
3. 在设置菜单中选择"Resources" > "Proxies"
4. 取消勾选"Use a proxy server"选项
5. 点击"Apply & Restart"按钮重启Docker Desktop

### 2. 修复后端代码

#### 2.1 替换pom.xml文件

我们已经为您创建了一个完整的pom.xml文件，包含所有必要的依赖：

1. 打开文件资源管理器，导航到 `h:\erpcrm\server` 目录
2. 备份原有的 `pom.xml` 文件（可选）
3. 从 `h:\erpcrm\client` 目录复制 `pom.xml.new` 文件到 `h:\erpcrm\server` 目录
4. 将 `pom.xml.new` 重命名为 `pom.xml`

#### 2.2 修复LogisticsTrace.java文件

1. 以管理员身份打开PowerShell
2. 导航到 `h:\erpcrm\client` 目录
3. 运行以下命令：
   ```powershell
   .\修复LogisticsTrace.ps1
   ```

### 3. 编译后端代码

1. 打开PowerShell，导航到 `h:\erpcrm\server` 目录
2. 运行以下命令编译代码：
   ```powershell
   mvn clean package -DskipTests
   ```
3. 等待编译完成，确保没有错误

### 4. 部署后端服务

1. 导航到 `h:\erpcrm\client` 目录
2. 运行以下命令部署服务：
   ```powershell
   docker-compose -f docker-compose-simple.yml up -d
   ```
3. 等待部署完成，检查服务状态：
   ```powershell
   docker-compose -f docker-compose-simple.yml ps
   ```
4. 查看后端服务日志：
   ```powershell
   docker-compose -f docker-compose-simple.yml logs -f backend
   ```

## 三、验证部署结果

1. 访问后端服务：
   - API地址：http://localhost:8082/api
   - 健康检查：http://localhost:8082/api/

2. 如果一切正常，您应该能看到后端服务的响应。

## 四、常见问题解决

### 1. Maven编译错误

如果遇到Maven编译错误，请检查：
- 确保您使用的是JDK 17
- 确保网络连接正常，能够访问Maven中央仓库
- 确保pom.xml文件已正确替换

### 2. Docker部署错误

如果遇到Docker部署错误，请检查：
- 确保Docker Desktop已正确重启，代理配置已关闭
- 确保网络连接正常，能够访问Docker Hub
- 查看Docker日志获取详细错误信息：
  ```powershell
  docker logs erpcrm_backend
  ```

### 3. 端口被占用

如果遇到端口被占用的错误，请检查：
- 确保8082端口未被其他程序占用
- 可以使用以下命令查看端口占用情况：
  ```powershell
  netstat -ano | findstr :8082
  ```

## 五、替代方案

如果您仍然遇到问题，可以考虑以下替代方案：

### 1. 使用本地编译的JAR文件

如果Maven编译成功，您可以直接使用生成的JAR文件运行后端服务，而不使用Docker：

```powershell
cd h:\erpcrm\serverava -jar target\erpcrm-1.0-SNAPSHOT.jar
```

### 2. 配置国内镜像加速器

如果无法访问Docker Hub，可以配置国内镜像加速器：

1. 打开Docker Desktop设置
2. 选择"Docker Engine"
3. 添加以下配置：
   ```json
   {
     "registry-mirrors": [
       "https://registry.docker-cn.com",
       "https://docker.mirrors.ustc.edu.cn",
       "https://hub-mirror.c.163.com"
     ]
   }
   ```
4. 点击"Apply & Restart"重启Docker Desktop

## 六、总结

通过按照本指南的步骤操作，您应该能够成功修复后端代码编译错误，并使用Docker Desktop部署ERP+CRM系统后端服务。

关键步骤：
1. 修复Docker Desktop代理配置
2. 替换pom.xml文件
3. 修复LogisticsTrace.java代码
4. 编译后端代码
5. 部署后端服务

如果您在修复过程中遇到任何问题，请随时联系我们获取进一步的帮助。

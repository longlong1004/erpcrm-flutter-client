# ERP+CRM系统后端编译修复指南

## 问题分析

在尝试编译后端服务时，遇到了以下主要错误：

1. **缺少ModelMapper依赖**
2. **缺少MyBatis Plus依赖**
3. **缺少MyBatis依赖**
4. **DataDictionaryServiceImpl.java中使用了ModelMapper但未配置**
5. **ApprovalDelegate相关代码依赖MyBatis Plus**

## 解决方案

### 1. 修改pom.xml文件，添加缺失的依赖

首先，您需要手动修改`h:\erpcrm\server\pom.xml`文件，添加以下依赖：

```xml
<!-- ModelMapper -->
<dependency>
    <groupId>org.modelmapper</groupId>
    <artifactId>modelmapper</artifactId>
    <version>3.2.0</version>
</dependency>

<!-- MyBatis Plus -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.5.5</version>
</dependency>

<!-- MyBatis -->
<dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis</artifactId>
    <version>3.5.16</version>
</dependency>
```

### 2. 修复DataDictionaryServiceImpl.java

修改`h:\erpcrm\server\src\main\java\com\erpcrm\server\service\settings\impl\DataDictionaryServiceImpl.java`文件，将ModelMapper替换为MapStruct或手动映射：

```java
// 原代码
private ModelMapper modelMapper = new ModelMapper();

// 修改为
private final DataDictionaryMapper dataDictionaryMapper;

// 在构造函数中注入
public DataDictionaryServiceImpl(DataDictionaryRepository dataDictionaryRepository, DataDictionaryMapper dataDictionaryMapper) {
    this.dataDictionaryRepository = dataDictionaryRepository;
    this.dataDictionaryMapper = dataDictionaryMapper;
}

// 使用MapStruct进行映射
```

### 3. 修复ApprovalDelegate相关代码

ApprovalDelegate相关代码依赖MyBatis Plus，您可以选择：

1. **保留并修复**：确保所有MyBatis Plus依赖都已正确添加
2. **临时禁用**：将ApprovalDelegate相关代码从编译中排除

### 4. 修复LogisticsTrace.java中的index()方法

修改`h:\erpcrm\server\src\main\java\com\erpcrm\server\model\logistics\LogisticsTrace.java`文件，移除@Column注解中的index()方法：

```java
// 原代码
@Column(name = "logistics_id", nullable = false, index = true)

// 修改为
@Column(name = "logistics_id", nullable = false)
```

## 本地编译步骤

1. 确保已完成上述修复
2. 打开PowerShell，导航到server目录：
   ```powershell
   cd h:\erpcrm\server
   ```
3. 运行Maven编译命令：
   ```powershell
   mvn clean package -DskipTests
   ```
4. 如果编译成功，会在target目录生成JAR文件

## Docker部署步骤

1. 确保Docker Desktop已正常运行
2. 打开PowerShell，导航到client目录：
   ```powershell
   cd h:\erpcrm\client
   ```
3. 使用修改后的docker-compose-simple.yml部署服务：
   ```powershell
   docker-compose -f docker-compose-simple.yml up -d
   ```
4. 检查服务状态：
   ```powershell
   docker-compose -f docker-compose-simple.yml ps
   ```
5. 查看日志：
   ```powershell
   docker-compose -f docker-compose-simple.yml logs -f backend
   ```

## 替代方案：使用预编译的JAR文件

如果您无法成功编译后端服务，可以考虑使用预编译的JAR文件。请按照以下步骤操作：

1. 将预编译的JAR文件复制到server目录
2. 创建一个简化的Dockerfile：
   ```dockerfile
   FROM openjdk:17-alpine
   WORKDIR /app
   COPY erpcrm-1.0-SNAPSHOT.jar app.jar
   EXPOSE 8082
   ENTRYPOINT ["java", "-jar", "app.jar"]
   ```
3. 使用docker-compose部署：
   ```powershell
   docker-compose -f docker-compose-simple.yml up -d
   ```

## 常见问题解决

### 1. Docker Desktop 500 Internal Server Error
- 重启Docker Desktop
- 检查系统资源（内存、磁盘空间）
- 重置Docker Desktop配置
- 确保网络连接正常

### 2. Maven编译错误
- 检查依赖配置是否正确
- 确保所有缺失的依赖都已添加
- 检查代码中的语法错误

### 3. Docker镜像拉取超时
- 检查网络连接
- 配置Docker镜像加速器
- 手动下载所需镜像

## 总结

通过按照本指南进行修复，您应该能够成功编译和部署ERP+CRM系统后端服务。如果您仍然遇到问题，请检查错误日志，根据具体错误信息进行进一步的排查和修复。

**注意**：确保使用正式版Docker Desktop，不要使用简化版或第三方修改版，以避免出现兼容性问题。

# ERP+CRM系统后端部署操作指南

## 前提条件
- Docker Desktop已安装并运行
- MySQL服务已在本地运行（端口3306）
- Redis服务已在本地运行（端口6379）

## 步骤1：检查Docker Desktop状态
1. 打开Docker Desktop应用
2. 点击左下角的"设置"图标
3. 选择"资源" -> "网络"
4. 确保"DNS服务器"设置为自动或正确的DNS服务器地址
5. 点击"应用并重启"（如果修改了设置）

## 步骤2：检查本地服务状态
1. 打开命令提示符（CMD）
2. 检查MySQL服务：`netstat -ano | findstr :3306`
   - 应该看到类似 `TCP    127.0.0.1:3306         0.0.0.0:0              LISTENING       6372` 的输出
3. 检查Redis服务：`netstat -ano | findstr :6379`
   - 应该看到类似 `TCP    127.0.0.1:6379         0.0.0.0:0              LISTENING       5308` 的输出

## 步骤3：修复后端项目依赖
1. 打开服务器目录：`cd h:\erpcrm\server`
2. 编辑pom.xml文件，添加缺失的依赖：
   ```xml
   <!-- 添加ModelMapper依赖 -->
   <dependency>
       <groupId>org.modelmapper</groupId>
       <artifactId>modelmapper</artifactId>
       <version>3.2.0</version>
   </dependency>
   
   <!-- 添加MyBatis Plus依赖 -->
   <dependency>
       <groupId>com.baomidou</groupId>
       <artifactId>mybatis-plus-boot-starter</artifactId>
       <version>3.5.5</version>
   </dependency>
   <dependency>
       <groupId>org.mybatis.spring.boot</groupId>
       <artifactId>mybatis-spring-boot-starter</artifactId>
       <version>3.0.3</version>
   </dependency>
   <dependency>
       <groupId>org.apache.ibatis</groupId>
       <artifactId>ibatis-core</artifactId>
       <version>3.0.3</version>
   </dependency>
   ```

## 步骤4：构建后端Docker镜像
1. 在服务器目录下创建简化的Dockerfile.local：
   ```dockerfile
   # 使用OpenJDK 17作为基础镜像
   FROM openjdk:17-alpine
   
   # 设置工作目录
   WORKDIR /app
   
   # 复制构建好的JAR文件
   COPY target/erpcrm-1.0-SNAPSHOT.jar app.jar
   
   # 暴露端口
   EXPOSE 8080
   
   # 启动应用
   ENTRYPOINT ["java", "-jar", "app.jar"]
   ```
2. 使用Maven编译项目：`mvn clean package -DskipTests`
3. 构建Docker镜像：`docker build -t erpcrm/backend:latest -f Dockerfile.local .`

## 步骤5：创建docker-compose配置
1. 在项目根目录创建docker-compose-local.yml：
   ```yaml
   version: '3.8'
   
   networks:
     erpcrm_network:
       driver: bridge
   
   # 后端服务 - 连接到本地MySQL和Redis
   services:
     backend:
       image: erpcrm/backend:latest
       container_name: erpcrm_backend
       restart: always
       networks:
         - erpcrm_network
       ports:
         - "8080:8080"
       environment:
         - SPRING_PROFILES_ACTIVE=local
         - SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/erpcrm_db?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
         - SPRING_DATASOURCE_USERNAME=root
         - SPRING_DATASOURCE_PASSWORD=erpcrm_root_password
         - SPRING_REDIS_HOST=host.docker.internal
         - SPRING_REDIS_PORT=6379
       extra_hosts:
         - "host.docker.internal:host-gateway"
   ```

## 步骤6：启动后端服务
1. 进入项目根目录：`cd h:\erpcrm`
2. 使用docker-compose启动服务：`docker compose -f docker-compose-local.yml up -d`
3. 查看服务状态：`docker compose -f docker-compose-local.yml ps`
4. 查看服务日志：`docker compose -f docker-compose-local.yml logs -f backend`

## 步骤7：验证服务
1. 打开浏览器，访问：http://localhost:8080/api
2. 应该看到Spring Boot的默认错误页面或API响应
3. 使用Postman测试API：
   - POST http://localhost:8080/api/auth/login
   - 请求体：`{"username": "admin", "password": "admin123"}`
   - 应该返回登录成功的响应

## 常见问题处理
1. **Docker Hub连接问题**：
   - 检查网络连接
   - 尝试更换DNS服务器
   - 使用Docker Desktop的"清理/恢复"功能重置Docker Desktop

2. **MySQL连接失败**：
   - 检查MySQL服务是否正在运行
   - 确认数据库连接信息正确
   - 检查防火墙是否允许连接

3. **Redis连接失败**：
   - 检查Redis服务是否正在运行
   - 确认Redis连接信息正确
   - 检查防火墙是否允许连接

## 停止服务
1. 使用docker-compose停止服务：`docker compose -f docker-compose-local.yml down`
2. 查看已停止的容器：`docker ps -a`
3. 清理未使用的资源：`docker system prune -f`

---

如果您在操作过程中遇到任何问题，请随时告诉我，我会为您提供进一步的帮助。